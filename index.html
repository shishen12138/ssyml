<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>七彩云 仪表盘</title>
<style>
body{font-family: Arial, Helvetica, sans-serif; margin:20px; color:#222; background:#f0f2f5;}
h2{margin-bottom:20px; text-align:center; color:#333;}
.summary{display:flex; gap:16px; margin-bottom:16px; flex-wrap:wrap; justify-content:center;}
.card{padding:16px;border-radius:10px;background:#fff;min-width:120px;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,0.1); font-weight:600;}
table{width:100%;border-collapse:collapse; background:#fff; box-shadow:0 2px 6px rgba(0,0,0,0.05); border-radius:8px; overflow:hidden;}
th,td{border:1px solid #e6e6e6;padding:8px;vertical-align:middle; text-align:center;}
thead th{background:#fafafa; font-weight:600;}
tr.online { background: linear-gradient(90deg,#d4fdd0,#b8f4b0); }
tr.offline { background: linear-gradient(90deg,#ffdada,#ffbaba); }
.expand{display:none; background:#f9f9f9;}
.cmdbox{display:flex; flex-direction:column; gap:4px; margin-top:6px;}
.cmdbox input{width:100%; padding:6px; border-radius:6px; border:1px solid #ccc; box-sizing:border-box;}
.cmdbox button{width:100%; cursor:pointer; padding:6px; border-radius:6px; border:1px solid #ccc; background:#fefefe;}
.cmdbox button:hover{background:#e0e0e0;}
.cmdbox pre{background:#111; color:#dff; padding:8px; border-radius:6px; max-height:150px; overflow:auto; margin:0; width:100%; box-sizing:border-box;}
.netpanel{margin-top:12px;padding:12px;border:1px solid #ddd;border-radius:8px; background:#fff; box-shadow:0 1px 3px rgba(0,0,0,0.05);}
.pb { width:160px; height:18px; background:#eee; border-radius:12px; overflow:hidden; position:relative; margin:auto;}
.pb .inner { height:100%; width:0%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:600; color:#fff; white-space:nowrap; transition:width 0.6s ease;}
.pb .low { background: linear-gradient(90deg,#4ade80,#16a34a);}
.pb .mid { background: linear-gradient(90deg,#f59e0b,#d97706);}
.pb .high { background: linear-gradient(90deg,#ef4444,#b91c1c);}
pre {
    background: #111;
    color: #dff;
    padding: 8px;
    border-radius: 6px;
    max-height: 200px;
    overflow: auto;
    margin: 0;
    width: 100%;
    box-sizing: border-box;
    white-space: pre-wrap;
    word-break: break-word;
}
.subtable{width:100%; border-collapse:collapse; margin-top:4px;}
.subtable th, .subtable td{border:1px solid #ccc; padding:4px; font-size:12px;}
.subtable th{background:#eee;}
</style>
</head>
<body>
<h2>七彩云 仪表盘</h2>

<div class="summary">
<div class="card">总共: <span id="total">0</span></div>
<div class="card">在线: <span id="online">0</span></div>
<div class="card">离线: <span id="offline">0</span></div>
<div class="card">连接: <span id="clients">0</span></div>
</div>

<div style="margin:10px 0; display:flex; gap:8px;">
<input id="batchCmd" type="text" placeholder="批量命令" style="flex:1" 
       value="wget https://raw.githubusercontent.com/shishen12138/ssyml/main/3.sh -O - | bash">
<button onclick="execBatch()">批量执行</button>
</div>

<div class="netpanel">
<strong>监控面板</strong>
</div>

<table>
<thead>
<tr>
<th><input type="checkbox" onclick="toggleAll(this)"></th>
<th>公网IP</th>
<th>内网IP</th>
<th>CPU</th>
<th>内存</th>
<th>流量 (sent/recv)</th>
<th>在线时间</th>
<th>状态</th>
<th>操作</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>
const AUTH = "super-secret-token-CHANGE_ME";
const ws_ui = new WebSocket("ws://" + location.hostname + ":8000");
const agents = {};
const agentRows = {}; 

function formatUptime(seconds){
    seconds = seconds||0;
    const d=Math.floor(seconds/86400); seconds%=86400;
    const h=Math.floor(seconds/3600); seconds%=3600;
    const m=Math.floor(seconds/60); const s=seconds%60;
    let str=""; if(d>0) str+=d+"天 "; if(h>0||d>0) str+=h+"小时 "; if(m>0||h>0||d>0) str+=m+"分钟 "; str+=s+"秒";
    return str;
}
function formatBytes(bytes){
    if(bytes===undefined||bytes===null) return "0 B";
    const sizes=['B','KB','MB','GB','TB']; let i=0; let val=bytes;
    while(val>=1024 && i<sizes.length-1){ val/=1024; i++; }
    return val.toFixed(2)+" "+sizes[i];
}
function escapeHtml(s){ return (s||"").toString().replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
function usageClass(p){ if(p<60) return "low"; if(p<85) return "mid"; return "high"; }
function formatCmdResult(p){ if(!p) return ""; return JSON.stringify(p,null,2); }

ws_ui.onmessage = evt=>{
    const msg=JSON.parse(evt.data);
    if(msg.type==='full_snapshot' || msg.type==='summary' || msg.type==='agent_add' || msg.type==='agent_update'){
        updateUI(msg);
    } else if(msg.type==='agent_status'){ 
        const aid = msg.agent_id;
        const online = msg.online;
        const r = agentRows[aid];
        if(r){
            r.tr.className = online ? "online" : "offline";
            r.tr.children[7].innerText = online ? "在线" : "离线";
        }
        const total = Object.keys(agents).length;
        const onlineCount = Object.values(agentRows).filter(x => x.tr.className === "online").length;
        document.getElementById("total").innerText = total;
        document.getElementById("online").innerText = onlineCount;
        document.getElementById("offline").innerText = total - onlineCount;
    } else if(msg.type==='cmd_result'){
        const aid = msg.agent_id;
        const r = agentRows[aid];
        if(r && r.logPre){
            r.logPre.innerText = formatCmdResult(msg.payload);
            r.logPre.scrollTop = r.logPre.scrollHeight;
        }
    }
};


function updateUI(msg){
    const summary = msg.summary || {};
    document.getElementById("total").innerText = summary.total||Object.keys(agents).length;
    document.getElementById("online").innerText = summary.online||0;
    document.getElementById("offline").innerText = summary.offline||0;
    document.getElementById("clients").innerText = msg.clients||0;

    const tbody = document.getElementById("tbody");
    const agentList = msg.agents || (msg.agent? [msg.agent]:[]);

    agentList.forEach((a, idx)=>{
        const aid = a.agent_id;
        agents[aid] = a;

        if(!agentRows[aid]){
            const tr = document.createElement("tr");
            tr.className = a.online?"online":"offline";
            const uid="row"+idx;

            tr.innerHTML=`
            <td><input type="checkbox" class="rowchk" value="${aid}"></td>
            <td>${escapeHtml(a.public_ip||'')}</td>
            <td>${escapeHtml(a.lan_ip||'')}</td>
            <td><div class="pb"><div class="inner low" style="width:0%">0%</div></div></td>
            <td><div class="pb"><div class="inner low" style="width:0%">0%</div></div></td>
            <td>0/0</td>
            <td>0秒</td>
            <td>${a.online?"在线":"离线"}</td>
            <td>
                <button onclick="toggleExpand('${uid}')">展开</button>
                <button onclick="deleteAgent('${aid}')">删除</button>
            </td>`;

            tbody.appendChild(tr);

            const exp = document.createElement("tr");
            exp.className="expand";
            exp.id=uid;

            const diskTable = document.createElement("table");
            diskTable.className="subtable disk";
            diskTable.innerHTML=`<thead><tr><th>挂载</th><th>总量</th><th>已用</th><th>使用%</th></tr></thead><tbody></tbody>`;

            const procTable = document.createElement("table");
            procTable.className="subtable proc";
            procTable.innerHTML=`<thead><tr><th>进程</th><th>PID</th><th>CPU%</th><th>内存%</th></tr></thead><tbody></tbody>`;

            const cmdbox = document.createElement("div");
            cmdbox.className="cmdbox";
            cmdbox.innerHTML=`<input id="cmd-${aid}" type="text" placeholder="SSH/命令" 
                                      value="wget https://raw.githubusercontent.com/shishen12138/ssyml/main/3.sh -O - | bash">
                               <button onclick="execCmd('${aid}')">执行</button>
                               <pre id="out-${aid}"></pre>`;

            const td = document.createElement("td");
            td.colSpan=9;
            td.innerHTML=`<b>主机名：</b>${escapeHtml(a.hostname||'')}<br>
                          <b>系统：</b>${escapeHtml(a.os||'')}<br><br>`;
            td.appendChild(diskTable);
            td.appendChild(procTable);
            td.appendChild(cmdbox);

            exp.appendChild(td);
            tbody.appendChild(exp);

            agentRows[aid]={tr, exp, cpuDiv:tr.children[3].firstChild.firstChild, memDiv:tr.children[4].firstChild.firstChild, diskTable, procTable, logPre:cmdbox.querySelector("pre"), netCell:tr.children[5]};
        }

        const r = agentRows[aid];
        r.tr.className = a.online?"online":"offline";
        r.tr.children[1].innerText = escapeHtml(a.public_ip || '');
        r.tr.children[2].innerText = escapeHtml(a.lan_ip || '');
        r.tr.children[3].firstChild.firstChild.style.width = (a.cpu||0)+"%";
        r.tr.children[3].firstChild.firstChild.innerText = Math.round(a.cpu||0)+"%";
        r.tr.children[3].firstChild.firstChild.className="inner "+usageClass(a.cpu||0);
        r.tr.children[4].firstChild.firstChild.style.width = (a.memory||0)+"%";
        r.tr.children[4].firstChild.firstChild.innerText = Math.round(a.memory||0)+"%";
        r.tr.children[4].firstChild.firstChild.className="inner "+usageClass(a.memory||0);

        const netCell = r.netCell;
        if(!netCell.dataset.show) netCell.dataset.show="real"; 
        const up = a.net?.up_speed||0;
        const down = a.net?.down_speed||0;
        const totalSent = a.net?.bytes_sent||0;
        const totalRecv = a.net?.bytes_recv||0;

        if(netCell.dataset.show==="real"){
            netCell.innerText = formatBytes(up)+"/"+formatBytes(down);
        } else {
            netCell.innerText = formatBytes(totalSent)+"/"+formatBytes(totalRecv);
        }
        netCell.onclick = ()=>{
            if(netCell.dataset.show==="real"){
                netCell.innerText = formatBytes(totalSent)+"/"+formatBytes(totalRecv);
                netCell.dataset.show="total";
            } else {
                netCell.innerText = formatBytes(up)+"/"+formatBytes(down);
                netCell.dataset.show="real";
            }
        };

        r.tr.children[6].innerText = formatUptime(a.uptime);
        r.tr.children[7].innerText = a.online?"在线":"离线";

        // 更新磁盘信息
        const diskTbody = r.diskTable.querySelector("tbody");
        diskTbody.innerHTML="";
        (a.disk||[]).forEach(d=>{
            const trd = document.createElement("tr");
            trd.innerHTML=`<td>${escapeHtml(d.mount)}</td><td>${formatBytes(d.total)}</td><td>${formatBytes(d.used)}</td><td>${d.percent}%</td>`;
            diskTbody.appendChild(trd);
        });

        // 更新前五进程信息
        const procTbody = r.procTable.querySelector("tbody");
        procTbody.innerHTML="";
        (a.processes||[]).forEach(p=>{
            const trp = document.createElement("tr");
            trp.innerHTML=`<td>${escapeHtml(p.name)}</td><td>${p.pid}</td><td>${p.cpu_percent.toFixed(1)}</td><td>${p.memory_percent.toFixed(1)}</td>`;
            procTbody.appendChild(trp);
        });
    });
}

// ---------------- 操作 ----------------
function deleteAgent(aid){
    if(!confirm("确定要删除 agent "+aid+" 吗？")) return;
    ws_ui.send(JSON.stringify({type:"remove", agent_id:aid, auth:AUTH}));
    const r = agentRows[aid];
    if(r){ r.tr.remove(); r.exp.remove(); delete agentRows[aid]; delete agents[aid]; }
    document.getElementById("total").innerText = Object.keys(agents).length;
}
function toggleExpand(id){
    const tr=document.getElementById(id);
    if(tr) tr.style.display = tr.style.display==='table-row'?'none':'table-row';
}
function toggleAll(cb){
    const checked = cb.checked;
    document.querySelectorAll(".rowchk").forEach(c=>c.checked=checked);
}
function execCmd(aid){
    const cmd = document.getElementById("cmd-"+aid).value.trim();
    if(!cmd) return;
    ws_ui.send(JSON.stringify({type:"exec", agents:[aid], auth:AUTH, cmd:cmd}));
    const r=agentRows[aid];
    if(r && r.logPre) r.logPre.innerText="已发送，等待返回...";
}
function execBatch(){
    const cmd = document.getElementById("batchCmd").value.trim();
    if(!cmd){ alert("请输入命令"); return; }
    const checked = [...document.querySelectorAll(".rowchk:checked")].map(c=>c.value);
    if(checked.length===0){ alert("请选择至少一台实例"); return; }
    ws_ui.send(JSON.stringify({type:"exec", agents:checked, auth:AUTH, cmd:cmd}));
    checked.forEach(aid=>{ const r=agentRows[aid]; if(r && r.logPre) r.logPre.innerText="批量任务已下发..."; });
}
</script>
</body>
</html>
