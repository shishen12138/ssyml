<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>SSH WebSocket 面板</title>
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.0/dist/jquery.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { padding: 20px; }
  #hosts_table td, #hosts_table th { vertical-align: middle; }
  .progress { height: 20px; }
  #log_box, #aws_log { height: 200px; overflow-y: scroll; background:#f7f7f7; padding:10px; border:1px solid #ccc; }
</style>
</head>
<body>

<h3>SSH WebSocket 面板</h3>

<div class="mb-3">
  <h5>手动添加 Host</h5>
  <div class="row g-2">
    <div class="col"><input id="add_ip" type="text" class="form-control" placeholder="IP"></div>
    <div class="col"><input id="add_username" type="text" class="form-control" placeholder="用户名" value="root"></div>
    <div class="col"><input id="add_password" type="text" class="form-control" placeholder="密码" value="Qcy1994@06"></div>
    <div class="col"><button id="add_host_btn" class="btn btn-primary">添加</button></div>
  </div>
</div>

<div class="mb-3">
  <h5>批量导入 AWS</h5>
  <textarea id="aws_accounts" class="form-control" rows="4" placeholder="名称----AccessKey----SecretKey"></textarea>
  <button id="import_aws_btn" class="btn btn-success mt-2">开始导入</button>
  <div class="progress mt-1">
    <div id="aws_progress" class="progress-bar" role="progressbar" style="width:0%">0%</div>
  </div>
  <pre id="aws_log"></pre>
</div>

<div class="mb-3">
  <h5>实例列表</h5>
  <table class="table table-bordered" id="hosts_table">
    <thead>
      <tr>
        <th>IP</th>
        <th>Region</th>
        <th>来源</th>
        <th>CPU %</th>
        <th>内存 %</th>
        <th>上传</th>
        <th>下载</th>
        <th>延迟 ms</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="mb-3">
  <h5>命令执行 & 日志</h5>
  <input id="cmd_input" type="text" class="form-control" placeholder="输入命令">
  <button id="exec_cmd_btn" class="btn btn-warning mt-2">执行命令</button>
  <pre id="log_box"></pre>
</div>

<script>
const socket = io();
let hosts = [];
let status_data = {};

// 刷新表格
function refresh_table(){
    const tbody = $("#hosts_table tbody");
    tbody.empty();
    hosts.forEach(h=>{
        const s = status_data[h.ip] || {};
        const cpu = s.cpu||'--';
        const mem = s.memory||'--';
        const net_rx = s.net_rx||'0';
        const net_tx = s.net_tx||'0';
        const latency = s.latency||'--';
        const row = `<tr>
            <td>${h.ip}</td>
            <td>${h.region||''}</td>
            <td>${h.source}</td>
            <td><div class="progress"><div class="progress-bar" style="width:${cpu}%">${cpu}</div></div></td>
            <td><div class="progress"><div class="progress-bar bg-info" style="width:${mem}%">${mem}</div></div></td>
            <td>${net_tx}</td>
            <td>${net_rx}</td>
            <td>${latency}</td>
            <td><button class="btn btn-sm btn-primary exec-btn" data-ip="${h.ip}">执行</button></td>
        </tr>`;
        tbody.append(row);
    });
}

// 获取 hosts 列表
function load_hosts(){
    $.get("/get_hosts", function(res){
        hosts = res;
    });
}

$(document).ready(function(){
    load_hosts();

    // 手动添加 host
    $("#add_host_btn").click(function(){
        $.post("/add_host", {
            ip: $("#add_ip").val(),
            username: $("#add_username").val(),
            password: $("#add_password").val()
        }, function(){ load_hosts(); });
    });

    // 批量导入 AWS
    $("#import_aws_btn").click(function(){
        $("#aws_progress").css('width','0%').text('0%');
        $("#aws_log").empty();
        $.post("/import_aws", {accounts: $("#aws_accounts").val()}, function(res){
            console.log("AWS 导入启动");
        });
    });

    // 执行命令
    $("#exec_cmd_btn").click(function(){
        const cmd = $("#cmd_input").val();
        const ips = hosts.map(h=>h.ip);
        socket.emit('exec_command', {cmd, ips});
    });

    // 单实例执行命令
    $(document).on('click','.exec-btn', function(){
        const ip = $(this).data('ip');
        const cmd = $("#cmd_input").val();
        socket.emit('exec_command', {cmd, ips:[ip]});
    });

    // WebSocket 事件
    socket.on('status', function(data){
        status_data = data;
        refresh_table();
    });

    socket.on('cmd_output', function(d){
        $("#log_box").append(`[${d.ip}] ${d.line}\n`);
        $("#log_box").scrollTop($("#log_box")[0].scrollHeight);
    });

    socket.on('log', function(d){
        $("#log_box").append(d.msg+"\n");
        $("#log_box").scrollTop($("#log_box")[0].scrollHeight);
    });

    socket.on('aws_import_log', function(d){
        $("#aws_log").append(d.msg+"\n");
        $("#aws_log").scrollTop($("#aws_log")[0].scrollHeight);
    });

    socket.on('aws_import_progress', function(d){
        $("#aws_progress").css('width', d.progress+'%').text(d.progress+'%');
    });

    socket.on('aws_import_complete', function(){
        load_hosts();
        $("#aws_log").append("导入完成\n");
        $("#aws_progress").css('width','100%').text('100%');
    });
});
</script>

</body>
</html>
