<!DOCTYPE html>
<html>
<head>
    <title>SSH WebSocket 面板</title>
    <script src="//cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .host-card { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
        .progress { height: 20px; }
        .chart-container { width: 300px; height: 100px; }
    </style>
</head>
<body>
<div class="container">
    <h1>SSH WebSocket 面板</h1>
    <div class="mb-3">
        <button class="btn btn-primary" onclick="execCmd()">执行命令</button>
        <button class="btn btn-secondary" onclick="setIntervalSeconds()">设置刷新间隔</button>
        <button class="btn btn-info" onclick="tailLog()">实时日志</button>
    </div>

    <div id="hosts"></div>

    <h3>日志</h3>
    <pre id="log" style="height:300px; overflow:auto; border:1px solid #ccc; padding:5px;"></pre>
</div>

<script>
var socket = io();

// 保存 chart 对象
var netCharts = {};

// 连接成功
socket.on('connect', function() {
    console.log('连接成功');
});

// 接收实时状态
socket.on('status', function(data) {
    var container = document.getElementById('hosts');
    container.innerHTML = ''; // 每次清空重绘
    for(var ip in data){
        var host = data[ip];
        var card = document.createElement('div');
        card.className = 'host-card';
        var html = `<h5>${ip}</h5>`;
        if(host.error){
            html += `<p style="color:red">错误: ${host.error}</p>`;
        } else {
            // CPU / 内存 / 磁盘进度条
            html += `
            <p>CPU: ${host.cpu}%</p>
            <div class="progress mb-1">
                <div class="progress-bar bg-success" role="progressbar" style="width:${host.cpu}%"></div>
            </div>
            <p>Memory: ${host.memory}%</p>
            <div class="progress mb-1">
                <div class="progress-bar bg-info" role="progressbar" style="width:${host.memory}%"></div>
            </div>
            <p>Disk: ${host.disk}</p>
            <div class="progress mb-1">
                <div class="progress-bar bg-warning" role="progressbar" style="width:${host.disk.replace('%','')}%"></div>
            </div>
            <p>Latency: ${host.latency} ms</p>
            `;

            // 网络流量图表
            html += `<canvas id="net-${ip}" class="chart-container"></canvas>`;

            // 前五进程表格
            html += `<table class="table table-sm table-bordered mt-2"><thead><tr><th>进程</th></tr></thead><tbody>`;
            host.top_processes.forEach(p => {
                html += `<tr><td>${p}</td></tr>`;
            });
            html += `</tbody></table>`;
        }
        card.innerHTML = html;
        container.appendChild(card);

        // 更新网络流量图表
        if(!host.error){
            var ctx = document.getElementById(`net-${ip}`).getContext('2d');
            var rx = parseInt(host.net_rx)/1024; // KB
            var tx = parseInt(host.net_tx)/1024; // KB
            if(netCharts[ip]){
                netCharts[ip].data.datasets[0].data = [rx, tx];
                netCharts[ip].update();
            } else {
                netCharts[ip] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['RX(KB)', 'TX(KB)'],
                        datasets: [{
                            label: '网络流量',
                            data: [rx, tx],
                            backgroundColor: ['#36a2eb','#ff6384']
                        }]
                    },
                    options: {
                        responsive: true,
                        animation: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }
        }
    }
});

// 接收命令执行结果
socket.on('cmd_result', function(data){
    alert(JSON.stringify(data, null, 4));
});

// 接收日志
socket.on('log', function(data){
    var pre = document.getElementById('log');
    pre.textContent += data.msg + "\n";
    pre.scrollTop = pre.scrollHeight; // 自动滚动到底部
});

// 执行命令
function execCmd(){
    var cmd = prompt("输入命令");
    if(!cmd) return;
    var ips = prompt("输入IP列表, 用逗号分隔").split(',');
    socket.emit('exec_command', {cmd: cmd, ips: ips});
}

// 设置刷新间隔
function setIntervalSeconds(){
    var sec = prompt("输入刷新间隔（秒）");
    if(!sec) return;
    socket.emit('set_interval', {interval: sec});
}

// 实时日志
function tailLog(){
    socket.emit('tail_log');
}
</script>
</body>
</html>
