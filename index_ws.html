<!DOCTYPE html>
<html>
<head>
    <title>SSH WebSocket 面板</title>
    <script src="//cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .host-card { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
        .progress { height: 20px; }
        .chart-container { width: 300px; height: 100px; }
        .form-inline { margin-bottom: 20px; }
    </style>
</head>
<body>
<div class="container">
    <h1>SSH WebSocket 面板</h1>

    <!-- 控制按钮 -->
    <div class="mb-3">
        <button class="btn btn-primary" onclick="execCmd()">执行命令</button>
        <button class="btn btn-secondary" onclick="setIntervalSeconds()">设置刷新间隔</button>
        <button class="btn btn-info" onclick="tailLog()">实时日志</button>
    </div>

    <!-- 手动添加主机 -->
    <div class="form-inline mb-3">
        <h5>手动添加主机</h5>
        <input type="text" id="host_ip" placeholder="IP" class="form-control mx-1">
        <input type="text" id="host_port" placeholder="端口" class="form-control mx-1" value="22">
        <input type="text" id="host_user" placeholder="用户名" class="form-control mx-1" value="root">
        <input type="text" id="host_pass" placeholder="密码" class="form-control mx-1">
        <button class="btn btn-success" onclick="addHost()">添加</button>
    </div>

    <!-- AWS 导入 -->
    <div class="form-inline mb-3">
        <h5>AWS 导入</h5>
        <textarea id="aws_accounts" placeholder="每行格式：任意前缀----AccessKey----SecretKey" class="form-control mx-1" rows="3" style="width:400px"></textarea>
        <button class="btn btn-warning" onclick="importAWS()">导入</button>
    </div>

    <!-- 主机显示区 -->
    <div id="hosts"></div>

    <h3>日志</h3>
    <pre id="log" style="height:300px; overflow:auto; border:1px solid #ccc; padding:5px;"></pre>
</div>

<script>
var socket = io();
var netCharts = {};

// 连接成功
socket.on('connect', function() {
    console.log('连接成功');
});

// 接收实时状态
socket.on('status', function(data) {
    var container = document.getElementById('hosts');
    container.innerHTML = '';
    for(var ip in data){
        var host = data[ip];
        var card = document.createElement('div');
        card.className = 'host-card';
        var html = `<h5>${ip}</h5>`;
        if(host.error){
            html += `<p style="color:red">错误: ${host.error}</p>`;
        } else {
            html += `
            <p>CPU: ${host.cpu}%</p>
            <div class="progress mb-1">
                <div class="progress-bar bg-success" role="progressbar" style="width:${host.cpu}%"></div>
            </div>
            <p>Memory: ${host.memory}%</p>
            <div class="progress mb-1">
                <div class="progress-bar bg-info" role="progressbar" style="width:${host.memory}%"></div>
            </div>
            <p>Disk: ${host.disk}</p>
            <div class="progress mb-1">
                <div class="progress-bar bg-warning" role="progressbar" style="width:${host.disk.replace('%','')}%"></div>
            </div>
            <p>Latency: ${host.latency} ms</p>
            `;
            html += `<canvas id="net-${ip}" class="chart-container"></canvas>`;
            html += `<table class="table table-sm table-bordered mt-2"><thead><tr><th>进程</th></tr></thead><tbody>`;
            host.top_processes.forEach(p => { html += `<tr><td>${p}</td></tr>`; });
            html += `</tbody></table>`;
        }
        card.innerHTML = html;
        container.appendChild(card);

        if(!host.error){
            var ctx = document.getElementById(`net-${ip}`).getContext('2d');
            var rx = parseInt(host.net_rx)/1024;
            var tx = parseInt(host.net_tx)/1024;
            if(netCharts[ip]){
                netCharts[ip].data.datasets[0].data = [rx, tx];
                netCharts[ip].update();
            } else {
                netCharts[ip] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['RX(KB)', 'TX(KB)'],
                        datasets: [{
                            label: '网络流量',
                            data: [rx, tx],
                            backgroundColor: ['#36a2eb','#ff6384']
                        }]
                    },
                    options: {
                        responsive: true,
                        animation: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }
        }
    }
});

// 命令结果
socket.on('cmd_result', function(data){
    alert(JSON.stringify(data, null, 4));
});

// 日志
socket.on('log', function(data){
    var pre = document.getElementById('log');
    pre.textContent += data.msg + "\n";
    pre.scrollTop = pre.scrollHeight;
});

// ---------------- 功能函数 ----------------
function execCmd(){
    var cmd = prompt("输入命令");
    if(!cmd) return;
    var ips = prompt("输入IP列表, 用逗号分隔").split(',');
    socket.emit('exec_command', {cmd: cmd, ips: ips});
}

function setIntervalSeconds(){
    var sec = prompt("输入刷新间隔（秒）");
    if(!sec) return;
    socket.emit('set_interval', {interval: sec});
}

function tailLog(){
    socket.emit('tail_log');
}

function addHost(){
    var ip = document.getElementById('host_ip').value;
    var port = document.getElementById('host_port').value || 22;
    var user = document.getElementById('host_user').value || 'root';
    var pass = document.getElementById('host_pass').value || '';
    if(!ip){ alert('请输入IP'); return; }

    var formData = new FormData();
    formData.append('ip', ip);
    formData.append('port', port);
    formData.append('username', user);
    formData.append('password', pass);

    fetch('/add_host', {method:'POST', body: formData})
    .then(res => res.json())
    .then(res => alert('添加成功'));
}

function importAWS(){
    var accounts = document.getElementById('aws_accounts').value;
    if(!accounts){ alert('请输入AWS账号'); return; }

    var formData = new FormData();
    formData.append('accounts', accounts);

    fetch('/import_aws', {method:'POST', body: formData})
    .then(res => res.json())
    .then(res => alert('导入完成'));
}
</script>
</body>
</html>
