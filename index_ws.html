<!DOCTYPE html>
<html>
<head>
    <title>SSH WebSocket 面板</title>
    <script src="//cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .progress { height: 20px; }
        .form-inline input { margin-right: 10px; }
    </style>
</head>
<body>
<div class="container">
    <h1>SSH WebSocket 面板</h1>

    <!-- 手动添加主机 -->
    <div class="mb-3">
        <h5>手动添加主机</h5>
        <div class="form-inline">
            <input type="text" id="manual_ip" placeholder="IP">
            <input type="text" id="manual_port" placeholder="端口" value="22">
            <input type="text" id="manual_user" placeholder="用户名" value="root">
            <input type="password" id="manual_pass" placeholder="密码">
            <button class="btn btn-primary" onclick="addHost()">添加</button>
        </div>
    </div>

    <!-- AWS 导入 -->
    <div class="mb-3">
        <h5>AWS 导入</h5>
        <textarea id="aws_accounts" class="form-control" rows="3" placeholder="格式: 任意备注----AccessKey----SecretKey"></textarea>
        <button class="btn btn-success mt-2" onclick="importAWS()">导入 AWS</button>
    </div>

    <!-- 功能按钮 -->
    <div class="mb-3">
        <button class="btn btn-secondary" onclick="setIntervalSeconds()">设置刷新间隔</button>
        <button class="btn btn-info" onclick="tailLog()">实时日志</button>
    </div>

    <!-- 主机表格 -->
    <table class="table table-bordered" id="hosts_table">
        <thead>
            <tr>
                <th><input type="checkbox" id="select_all" onclick="toggleAll(this)"></th>
                <th>IP</th>
                <th>CPU</th>
                <th>内存</th>
                <th>流量 (RX/TX KB)</th>
                <th>延迟 (ms)</th>
            </tr>
        </thead>
        <tbody id="hosts_body"></tbody>
    </table>

    <!-- 命令执行 -->
    <button class="btn btn-primary" onclick="execSelectedCmd()">执行选择的命令</button>

    <!-- 日志 -->
    <h3>日志</h3>
    <pre id="log" style="height:300px; overflow:auto; border:1px solid #ccc; padding:5px;"></pre>
</div>

<script>
var socket = io();
var hostsData = {}; // 保存最新状态

// ---------- 接收主机状态 ----------
socket.on('status', function(data){
    hostsData = data;
    var tbody = document.getElementById('hosts_body');
    tbody.innerHTML = '';
    for(var ip in data){
        var h = data[ip];
        var row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="checkbox" class="host_select" data-ip="${ip}"></td>
            <td>${ip}</td>
            <td>
                ${h.cpu !== '-' ? h.cpu + '%' : '-'}
                <div class="progress mt-1"><div class="progress-bar bg-success" role="progressbar" style="width:${h.cpu !== '-' ? h.cpu : 0}%"></div></div>
            </td>
            <td>
                ${h.memory !== '-' ? h.memory + '%' : '-'}
                <div class="progress mt-1"><div class="progress-bar bg-info" role="progressbar" style="width:${h.memory !== '-' ? h.memory : 0}%"></div></div>
            </td>
            <td>${h.net_rx || 0}/${h.net_tx || 0}</td>
            <td>${h.latency || '-'}</td>
        `;
        tbody.appendChild(row);
    }
});

// ---------- 接收日志 ----------
socket.on('log', function(data){
    var pre = document.getElementById('log');
    pre.textContent += data.msg + "\n";
    pre.scrollTop = pre.scrollHeight;
});

// ---------- 全选 / 全不选 ----------
function toggleAll(checkbox){
    var selects = document.querySelectorAll('.host_select');
    selects.forEach(cb => cb.checked = checkbox.checked);
}

// ---------- 执行选择的命令 ----------
function execSelectedCmd(){
    var cmd = prompt("输入命令");
    if(!cmd) return;
    var ips = [];
    document.querySelectorAll('.host_select:checked').forEach(cb => ips.push(cb.dataset.ip));
    if(ips.length === 0){ alert("请至少选择一个主机"); return; }
    socket.emit('exec_command', {cmd: cmd, ips: ips});
}

// ---------- 手动添加主机 ----------
function addHost(){
    var ip = document.getElementById('manual_ip').value;
    var port = document.getElementById('manual_port').value || 22;
    var user = document.getElementById('manual_user').value || 'root';
    var pass = document.getElementById('manual_pass').value || '';
    if(!ip){ alert('IP不能为空'); return; }

    var formData = new FormData();
    formData.append('ip', ip);
    formData.append('port', port);
    formData.append('username', user);
    formData.append('password', pass);

    fetch('/add_host', {method:'POST', body:formData})
    .then(res=>res.json())
    .then(res=>{
        alert('添加完成');
        socket.emit('refresh_hosts');
    });
}

// ---------- AWS 导入 ----------
function importAWS(){
    var accounts = document.getElementById('aws_accounts').value;
    if(!accounts){ alert('请输入AWS账号'); return; }

    var formData = new FormData();
    formData.append('accounts', accounts);

    fetch('/import_aws', {method:'POST', body: formData})
    .then(res => res.json())
    .then(res => {
        alert('导入开始，请查看日志获取进度...');
    });
}

// ---------- 设置刷新间隔 ----------
function setIntervalSeconds(){
    var sec = prompt("输入刷新间隔（秒）");
    if(!sec) return;
    socket.emit('set_interval', {interval: sec});
}

// ---------- 实时日志 ----------
function tailLog(){ socket.emit('tail_log'); }
</script>
</body>
</html>
