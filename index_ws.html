<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>SSH 面板</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
body { font-family: Arial, sans-serif; background: #f5f5f5; margin:0; padding:0;}
header { background:#333; color:#fff; padding:10px; text-align:center; }
.container { padding:10px; }
.host-card { background:#fff; border-radius:5px; padding:10px; margin-bottom:10px; box-shadow:0 0 5px rgba(0,0,0,0.1);}
.progress { background:#eee; border-radius:3px; height:10px; margin:3px 0; }
.progress-bar { height:10px; border-radius:3px; }
.status-online { color:green; font-weight:bold; }
.status-offline { color:red; font-weight:bold; }
.top-table { width:100%; border-collapse: collapse; margin-top:5px; }
.top-table th, .top-table td { border:1px solid #ccc; padding:2px 5px; font-size:12px; }
#logArea { background:#000; color:#0f0; height:150px; overflow:auto; padding:5px; margin-bottom:10px; font-size:12px; }
button { margin:2px; padding:5px 8px; cursor:pointer; }
</style>
</head>
<body>
<header><h2>SSH 面板</h2></header>
<div class="container">

<h3>日志输出</h3>
<div id="logArea"></div>

<h3>手动添加主机</h3>
<input type="text" id="manualIp" placeholder="IP">
<input type="text" id="manualUser" placeholder="用户名" value="root">
<input type="text" id="manualPass" placeholder="密码" value="Qcy1994@06">
<button onclick="addHost()">添加主机</button>

<h3>AWS导入</h3>
<textarea id="awsAccounts" placeholder="账号----AccessKey----SecretKey" rows="4" style="width:100%"></textarea><br>
<button onclick="importAWS()">导入 AWS</button>

<h3>批量执行命令</h3>
<textarea id="cmdInput" placeholder="输入命令" rows="2" style="width:100%"></textarea><br>
<button onclick="execCmd()">执行命令</button>

<h3>主机列表</h3>
<div id="hostsContainer"></div>
</div>

<script>
const socket = io();
let hostsData = {};

function addLog(msg){
    const logArea = document.getElementById('logArea');
    logArea.innerHTML += msg + "<br>";
    logArea.scrollTop = logArea.scrollHeight;
}

// -------------------- WebSocket --------------------
socket.on('log', data=>{
    addLog(data.msg);
});

socket.on('status', data=>{
    hostsData = data;
    renderHosts();
});

socket.on('cmd_result', data=>{
    for(const ip in data){
        addLog(`[${ip}] ${data[ip]}`);
    }
});

// -------------------- 渲染主机 --------------------
function renderHosts(){
    const container = document.getElementById('hostsContainer');
    container.innerHTML = '';
    for(const ip in hostsData){
        const h = hostsData[ip];
        const card = document.createElement('div');
        card.className = 'host-card';
        card.innerHTML = `
            <strong>${ip}</strong> [${h.source || 'manual'}] - 
            <span class="${h.status==='在线'?'status-online':'status-offline'}">${h.status}</span><br>
            CPU: <div class="progress"><div class="progress-bar" style="width:${h.cpu}% ;background:orange;"></div></div>
            内存: <div class="progress"><div class="progress-bar" style="width:${h.memory}% ;background:blue;"></div></div>
            磁盘: <div class="progress"><div class="progress-bar" style="width:${parseInt(h.disk)}%;background:green;"></div></div>
            <button onclick="toggleTop('${ip}')">Top进程</button>
            <div id="top-${ip}" style="display:none;">
                <table class="top-table">
                    <tr><th>用户</th><th>PID</th><th>%CPU</th><th>%MEM</th><th>命令</th></tr>
                    ${h.top_processes ? h.top_processes.map(p=>{
                        const parts = p.trim().split(/\s+/);
                        return `<tr>${parts.map(pp=>'<td>'+pp+'</td>').join('')}</tr>`;
                    }).join('') : ''}
                </table>
            </div>
            <input type="checkbox" class="host-checkbox" value="${ip}">选择
        `;
        container.appendChild(card);
    }
}

function toggleTop(ip){
    const div = document.getElementById('top-'+ip);
    div.style.display = div.style.display==='none'?'block':'none';
}

// -------------------- 前端操作 --------------------
function addHost(){
    const ip = document.getElementById('manualIp').value;
    const username = document.getElementById('manualUser').value;
    const password = document.getElementById('manualPass').value;
    if(!ip) return alert('请输入IP');
    fetch('/add_host',{
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:`ip=${encodeURIComponent(ip)}&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`
    }).then(res=>res.json()).then(data=>{
        addLog(data.msg || `手动添加 ${ip}`);
    });
}

function importAWS(){
    const accounts = document.getElementById('awsAccounts').value;
    if(!accounts) return alert('请输入AWS账号信息');
    fetch('/import_aws',{
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:'accounts='+encodeURIComponent(accounts)
    }).then(res=>res.json()).then(data=>{
        addLog(data.msg || 'AWS导入启动');
    });
}

function execCmd(){
    const cmd = document.getElementById('cmdInput').value;
    if(!cmd) return alert('请输入命令');
    const checkboxes = document.querySelectorAll('.host-checkbox:checked');
    const ips = Array.from(checkboxes).map(c=>c.value);
    if(ips.length===0) return alert('请选择主机');
    socket.emit('exec_command',{cmd, ips});
    addLog(`命令已发送: ${cmd}`);
}
</script>
</body>
</html>
